---
import { Image } from 'astro:assets';
import { getCollection, type CollectionEntry } from 'astro:content';
import squareImage from '../assets/alex/square.webp';
import Card from '../components/content/Card.astro';
import FeaturesGrid from '../components/home/FeaturesGrid.astro';
import Hero from '../components/home/Hero.astro';
import NewsBanner from '../components/layout/NewsBanner.astro';
import Button from '../components/ui/Button.astro';
import SectionHeader from '../components/ui/SectionHeader.astro';
import Layout from '../layouts/Layout.astro';
import { logError } from '../lib/api/error-handler';
import { getEntrySlugs } from '../services/content-slug';

let newsPosts: CollectionEntry<'news'>[] = [];
let holidays: CollectionEntry<'holiday'>[] = [];

try {
  newsPosts = await getCollection('news');
  holidays = await getCollection('holiday');
} catch (error) {
  logError(error, { context: 'Homepage Collections Loading' });
}

const sortedNewsPosts = newsPosts.sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);
const recentPosts = sortedNewsPosts.slice(0, 2);

const now = new Date().getTime();
const activeHolidays = holidays.filter((holiday) => {
  const startDate = new Date(holiday.data.startDate).getTime();
  return startDate >= now;
});

const sortedHolidays = activeHolidays.sort(
  (a, b) =>
    new Date(a.data.startDate).getTime() - new Date(b.data.startDate).getTime()
);
const upcomingHolidays = sortedHolidays.slice(0, 1);

const recentPostSlugMap = getEntrySlugs(recentPosts);
const upcomingHolidaySlugMap = getEntrySlugs(upcomingHolidays, 'holiday');
---

<Layout title="Bridge mit Alexander">
  <NewsBanner />
  <Hero />

  <section id="why" class="section">
    <div class="max-w-4xl mx-auto">
      <SectionHeader
        title="Warum Bridge mit uns lernen?"
        description="Entdecken Sie die Vorteile unserer Bridge-Kurse"
      />
      <FeaturesGrid
        features={[
          {
            icon: 'üéì',
            title: 'Expertenunterricht',
            description:
              'Lernen Sie von erfahrenen Bridge-Profis mit jahrzehntelanger Erfahrung.',
          },
          {
            icon: 'üë•',
            title: 'Kleine Gruppen',
            description:
              'Personalisierte Aufmerksamkeit in intimen Klasseneinstellungen.',
          },
          {
            icon: 'üìÖ',
            title: 'Flexible Zeitplanung',
            description: 'W√§hlen Sie aus einer Vielzahl von Kurszeiten.',
          },
        ]}
      />
    </div>
  </section>

  {/* About Alexander - Consistent Styling */}
  <section id="about" class="section">
    <div class="max-w-4xl mx-auto">
      <div class="p-8 card md:p-12">
        <div
          class="flex flex-col items-center gap-8 lg:flex-row lg:items-start lg:gap-12"
        >
          <div class="flex-shrink-0">
            <Image
              src={squareImage}
              alt="Alexander - Bridge-Lehrer"
              class="object-cover w-48 h-48 border-[3px] border-black rounded-2xl shadow-[4px_4px_0_#000] md:h-64 md:w-64"
              width={512}
              height={512}
            />
          </div>
          <div class="flex-1 space-y-4 text-center lg:text-left">
            <h2 class="text-3xl font-black leading-tight md:text-4xl">
              Alexander
            </h2>
            <p class="text-lg font-bold text-gray-700">
              Mehrfacher Deutscher Meister, Coach, Bridgelehrer, Turnierleiter
              und Reiseveranstalter
            </p>
            <p class="text-base text-gray-700">
              Alexander z√§hlt zu den profiliertesten Pers√∂nlichkeiten der
              deutschen Bridgeszene. Das Bridgespielen hat er bereits im Alter
              von f√ºnf Jahren von seinem Vater erlernt. Mit neun Jahren nahm er
              an seinem ersten Bridgeturnier teil ‚Äì der Beginn einer
              au√üergew√∂hnlichen Karriere.
            </p>
          </div>
        </div>
      </div>

      {/* Professional Focus */}
      <div class="mt-12 space-y-6">
        <h3 class="text-2xl font-bold text-center">Berufliche Schwerpunkte</h3>
        <div class="grid gap-6 md:grid-cols-2">
          <div class="p-6 card">
            <div class="space-y-3">
              <div class="flex items-center gap-3">
                <span class="text-3xl">üíº</span>
                <h4 class="text-xl font-bold">Professioneller Lehrer</h4>
              </div>
              <ul class="space-y-2 text-gray-700">
                <li>‚Ä¢ Bridgeunterricht f√ºr alle Spielstufen</li>
                <li>‚Ä¢ Einf√ºhrungskurse, Schulungsreihen</li>
                <li>‚Ä¢ Turniertraining nach DBV-Standards</li>
              </ul>
            </div>
          </div>

          <div class="p-6 card">
            <div class="space-y-3">
              <div class="flex items-center gap-3">
                <span class="text-3xl">üèÜ</span>
                <h4 class="text-xl font-bold">Coaching & Organisation</h4>
              </div>
              <ul class="space-y-2 text-gray-700">
                <li>‚Ä¢ Coaching f√ºr ambitionierte Spieler und Clubs</li>
                <li>‚Ä¢ Organisation von Bridge-Reisen und Seminaren</li>
                <li>‚Ä¢ Entwicklung von Lehrmaterialien</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      {/* Achievements */}
      <div class="p-8 mt-12 card">
        <h3 class="mb-6 text-2xl font-bold text-center">
          Erfolge & Auszeichnungen
        </h3>
        <div class="space-y-4 text-gray-700">
          <p>
            <strong>Im Alter von 17 Jahren</strong> wurde er erstmals in die deutsche
            Juniorennationalmannschaft berufen. Das Bridgespielen hat er zum Beruf
            gemacht und hat seitdem Hunderte von Sch√ºlern unterrichtet.
          </p>
          <ul class="space-y-2">
            <li>‚Ä¢ <strong>Mehrfacher Deutscher Meister</strong></li>
            <li>‚Ä¢ <strong>Erfolge</strong> bei internationalen Wettbewerben</li>
            <li>‚Ä¢ <strong>Veranstalter</strong> renommierter Bridge-Events</li>
            <li>‚Ä¢ <strong>Mentoring</strong> f√ºr Nachwuchsspieler</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  {
    upcomingHolidays.length > 0 && (
      <section id="reisen" class="section">
        <div class="max-w-4xl mx-auto">
          <SectionHeader
            title="Kommende Reisen"
            description="Entdecken Sie unsere n√§chsten Bridge-Reisen"
          />
          <div class="grid gap-6 md:grid-cols-1">
            {upcomingHolidays.map((holiday) => {
              const slug = upcomingHolidaySlugMap.get(holiday) ?? '';

              return (
                <Card
                  title={holiday.data.title}
                  image={holiday.data.image}
                  href={`/holiday/${slug}`}
                  dateRange={{
                    start: holiday.data.startDate,
                    end: holiday.data.endDate,
                  }}
                  imagePosition="top"
                  showArrow={true}
                />
              );
            })}
          </div>
          <div class="flex justify-center mt-8">
            <Button text="Alle Reisen" href="/holiday" />
          </div>
        </div>
      </section>
    )
  }

  {
    recentPosts.length > 0 && (
      <section id="news" class="section">
        <div class="max-w-4xl mx-auto">
          <SectionHeader
            title="Neueste Beitr√§ge"
            description="Aktuelle Bridge-Neuigkeiten und Tipps"
          />
          <div class="flex flex-col gap-6 md:flex-row">
            {recentPosts.map((post, index) => {
              const slug = recentPostSlugMap.get(post) ?? '';

              return (
                <div class={index === 0 ? 'md:w-2/3 flex' : 'md:w-1/3 flex'}>
                  <Card
                    title={post.data.title}
                    href={`/news/${slug}`}
                    date={post.data.date}
                    images={post.data.photos}
                    imagePosition="left"
                    showArrow={true}
                    class="w-full"
                  />
                </div>
              );
            })}
          </div>
          <div class="flex justify-center mt-8">
            <Button text="Alle Beitr√§ge" href="/news" />
          </div>
        </div>
      </section>
    )
  }
</Layout>
